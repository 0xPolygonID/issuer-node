openapi: 3.1.0
info:
  title: Polygon ID - Issuer - UI API
  description: |
    Documentation for the Issuer - UI API
  version: 0.1.0

servers:
  - description: Local
    url: http://localhost:3002

tags:
  - name: Identity
    description: Collection of endpoints related to Identity
  - name: Credential
    description: Collection of endpoints related to Credential
  - name: Agent
    description: Collection of endpoints related to Mobile
  - name: Connection
    description: Collection of endpoints related to Connections

paths:
  #authentication
  /v1/authentication/qrcode:
    get:
      summary: Get Authentication QRCode
      operationId: authQRCode
      description: Authentication qrcode
      tags:
        - auth
      responses:
        '200':
          description: authentication qrcode
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticationQrCodeResponse'
        '500':
          $ref: '#/components/responses/500'

  /v1/authentication/callback:
    post:
      summary: Authentication Callback
      operationId: authCallback
      description: Authentication callback
      tags:
        - auth
      parameters:
        - $ref: '#/components/parameters/sessionID'
      requestBody:
        required: true
        content:
          text/plain:
            schema:
              type: string
              example: jwz-token
      responses:
        '200':
          description: ok
        '400':
          $ref: '#/components/responses/400'
        '500':
          $ref: '#/components/responses/500'

  #connections:
  /v1/connections/{id}:
    get:
      summary: Get Connection
      operationId: getConnection
      description: get connection
      tags:
        - Connection
      security:
        - basicAuth: [ ]
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetConnectionResponse'
        '400':
          $ref: '#/components/responses/400'
        '500':
          $ref: '#/components/responses/500'
    delete:
      summary: Delete Connection
      operationId: deleteConnection
      description: delete connection
      tags:
        - Connection
      security:
        - basicAuth: [ ]
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericMessage'
        '400':
          $ref: '#/components/responses/400'
        '500':
          $ref: '#/components/responses/500'

  #credentials:
  /v1/credentials:
    get:
      summary: Get all credentials. Optional filter by status and text query search.
      operationId: GetCredentials
      description: Return all the credentials that matches the filter
      tags:
        - Credential
      security:
        - basicAuth: [ ]
      parameters:
        - in: query
          name: type
          schema:
            type: string
            enum: [all, revoked, expired]
          description: >
             Schema type:
               * `all` - All schemas. Default value if query parameter is not present
               * `revoked` - Only revoked schemas
               * `expired` - Only expired schemas
        - in: query
          name: query
          schema:
            type: string
          description: Query string to do full text search
      responses:
        '200':
          description: List of credentials
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Credential'
        '400':
          $ref: '#/components/responses/400'
        '404':
          $ref: '#/components/responses/404'
        '500':
          $ref: '#/components/responses/500'
    post:
      summary: Create Credential
      operationId: CreateCredential
      description: Endpoint to create a Credential
      tags:
        - Credential
      security:
        - basicAuth: [ ]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCredentialRequest'
      responses:
        '201':
          description: Claim created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateCredentialResponse'
        '400':
          $ref: '#/components/responses/400'
        '401':
          $ref: '#/components/responses/401'
        '422':
          $ref: '#/components/responses/422'
        '500':
          $ref: '#/components/responses/500'

  /v1/credentials/revoke/{nonce}:
    post:
      summary: Revoke Credential
      operationId: RevokeCredential
      description: Endpoint to revoke a credential
      tags:
        - Credential
      security:
        - basicAuth: [ ]
      parameters:
        - $ref: '#/components/parameters/pathNonce'
      responses:
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevokeCredentialResponse'
        '401':
          $ref: '#/components/responses/401'
        '404':
          $ref: '#/components/responses/404'
        '500':
          $ref: '#/components/responses/500'

  /v1/credentials/{id}:
    get:
      summary: Get Credential
      operationId: getCredential
      description: Get credential details
      tags:
        - Credential
      security:
        - basicAuth: [ ]
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Credential'
        '400':
          $ref: '#/components/responses/400'
        '500':
          $ref: '#/components/responses/500'
    delete:
      summary: Delete Credential
      operationId: DeleteCredential
      description: Endpoint to delete a Credential
      tags:
        - Credential
      security:
        - basicAuth: [ ]
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Claim deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericMessage'
        '400':
          $ref: '#/components/responses/400'
        '401':
          $ref: '#/components/responses/401'
        '500':
          $ref: '#/components/responses/500'

  #schemas:
  /v1/schemas/{id}:
    get:
      summary: Get Schema
      operationId: GetSchema
      security:
        - basicAuth: [ ]
      tags:
        - Schemas
      parameters:
        - $ref: '#/components/parameters/id'
      responses:
        '200':
          description: Schema information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Schema'
        '400':
          $ref: '#/components/responses/400'
        '404':
          $ref: '#/components/responses/404'
        '500':
          $ref: '#/components/responses/500'

  /v1/schemas:
    get:
      summary: Get Schemas
      operationId : GetSchemas
      security:
        - basicAuth: [ ]
      tags:
        - Schemas
      parameters:
        - in: query
          name: query
          schema:
            type: string
          description: Query string to do full text search in schema types and attributes.
      responses:
        '200':
          description: Schema collection
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Schema'
        '400':
          $ref: '#/components/responses/400'
        '500':
          $ref: '#/components/responses/500'

    post:
      summary: Import JSON schema
      operationId: ImportSchema
      security:
        - basicAuth: [ ]
      tags:
        - Schemas
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImportSchemaRequest'
      responses:
        '201':
          description: Schema imported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UUIDResponse'
        '400':
          $ref: '#/components/responses/400'
        '500':
          $ref: '#/components/responses/500'

  #others:
  /:
    get:
      summary: Get the documentation
      operationId: GetDocumentation
      x-internal: true
      responses:
        200:
          description: success and returns the documentation in HTML format

  /static/docs/api_admin/api.yaml:
    get:
      summary: Get the documentation yaml file
      operationId: GetYaml
      x-internal: true
      responses:
        200:
          description: success and returns the documentation in Yaml format

  /status:
    get:
      summary: Healthcheck
      operationId: Health
      responses:
        '200':
          description: All services are running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Health'
        '500':
          $ref: '#/components/responses/500'

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic

  schemas:
    ImportSchemaRequest:
      type: object
      required:
        - url
        - schemaType
      properties:
        url:
          type: string
          example: "https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json/KYCAgeCredential-v3.json"
        schemaType:
          type: string
          example: "vaccinationCertificate"

    Health:
      type: object
      x-omitempty: false
      additionalProperties:
        type: boolean

    AuthenticationQrCodeResponse:
      type: object
      required:
        - id
        - typ
        - type
        - thid
        - body
        - from
      properties:
        id:
          type: string
        typ:
          type: string
        type:
          type: string
        thid:
          type: string
        body:
          type: object
          required:
            - callbackUrl
            - reason
            - scope
          properties:
            callbackUrl:
              type: string
            reason:
              type: string
            scope:
              type: array
        from:
          type: string

    UUIDResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          x-omitempty: false

    GenericErrorMessage:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          example: 'Something happen'

    Credential:
      type: object
      required:
        - id
        - proofTypes
        - createdAt
        - expired
        - schemaHash
        - schemaType
        - revNonce
        - attributes
        - revoked
      properties:
        id:
          type: string
          x-go-type: uuid.UUID
          x-go-type-import:
            name: uuid
            path: github.com/google/uuid
        proofTypes:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        expiresAt:
          type: string
          format: date-time
        expired:
          type: boolean
        schemaHash:
          type: string
        schemaType:
          type: string
        revoked:
          type: boolean
        revNonce:
          type: integer
          format: uint64
        attributes:
          type: object
          x-omitempty: false

    GenericMessage:
      type: object
      required:
        - message
      properties:
        message:
          type: string

    Connection:
      type: object
      required:
        - id
        - userID
        - issuerID
        - createdAt
      properties:
        id:
          type: string
          x-omitempty: false
        userID:
          type: string
          x-omitempty: false
        issuerID:
          type: string
          x-omitempty: false
        createdAt:
          type: string
          format: date-time


    GetConnectionResponse:
      type: object
      required:
        - connection
        - credentials
      properties:
        connection:
          $ref: '#/components/schemas/Connection'
        credentials:
          type: array
          items:
            $ref: '#/components/schemas/Credential'

    CreateCredentialRequest:
      type: object
      required:
        - credentialSchema
        - type
        - credentialSubject
      properties:
        credentialSchema:
          type: string
          x-omitempty: false
        type:
          type: string
          x-omitempty: false
        credentialSubject:
          type: object
          x-omitempty: false
        expiration:
          type: integer
          format: int64
      example:
        credentialSchema: "https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json/KYCAgeCredential-v3.json"
        type: "KYCAgeCredential"
        credentialSubject:
          id: "fill with did"
          birthday: 19960424
          documentType: 2
        expiration: 12345

    Schema:
      type: object
      required:
        - id
        - hash
        - bigInt
        - url
        - type
        - createdAt
      properties:
        id:
          type: string
          x-omitempty: false
        hash:
          type: string
          x-omitempty: false
        bigInt:
          type: string
          x-omitempty: false
        url:
          type: string
          x-omitempty: false
        type:
          type: string
          x-omitempty: false
        createdAt:
          type: string
          format: date-time
          x-omitempty: false

    CreateCredentialResponse:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          x-omitempty: false

    RevokeCredentialResponse:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          x-omitempty: false
          example: pending
  parameters:
    sessionID:
      name: sessionID
      in: query
      required: true
      description: Session ID
      schema:
        type: string
        x-go-type: uuid.UUID
        x-go-type-import:
          name: uuid
          path: github.com/google/uuid

    id:
      name: id
      in: path
      required: true
      description: id
      schema:
        type: string
        x-go-type: uuid.UUID
        x-go-type-import:
          name: uuid
          path: github.com/google/uuid

    pathNonce:
      name: nonce
      in: path
      required: true
      description: Claim nonce
      schema:
        type: integer
        format: int64
  responses:
    '400':
      description: 'Bad Request'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericErrorMessage'
    '401':
      description: 'Unauthorized'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericErrorMessage'
    '404':
      description: 'Entity not found'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericErrorMessage'
    '422':
      description: 'Unprocessable Content'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericErrorMessage'
    '500':
      description: 'Internal Server error'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GenericErrorMessage'
